# إصلاح مشكلة 403 للمدير - Manager 403 Fix

## المشكلة

كان المدير يواجه رسالة 403 "غير مصرح لك بعرض هذه المهمة" عند محاولة الوصول للمهام التي يديرها، رغم أن الاختبارات أثبتت أن المنطق صحيح.

## سبب المشكلة

بعد التحليل، تم اكتشاف أن المشكلة كانت في الـ view `manager/tasks/show.blade.php` التي كانت تستخدم متغير `$isManagerOfTeam` لم يتم تمريره من الـ controller.

## الإصلاحات المطبقة

### 1. إصلاح دالة show في TaskController

تم إضافة تمرير المتغير المطلوب للـ view:

```php
// قبل الإصلاح
return view('manager.tasks.show', [
    'task' => $task,
]);

// بعد الإصلاح
$managedTeamIds = $user->teams()->wherePivot('role', 'manager')->pluck('teams.id')->toArray();
$isManagerOfTeam = in_array($task->team_id, $managedTeamIds);

return view('manager.tasks.show', [
    'task' => $task,
    'isManagerOfTeam' => $isManagerOfTeam,
]);
```

### 2. إصلاح الـ view

تم تحسين الـ view وإصلاح المسارات:

```php
// إصلاح المسارات
@if($isManagerOfTeam)
    <a href="{{ route('manager.tasks.edit', $task) }}" class="btn btn-warning">تعديل</a>
    <form action="{{ route('manager.tasks.destroy', $task) }}" method="POST">
        <!-- حذف -->
    </form>
@else
    <form action="{{ route('manager.my-tasks.updateStatus', $task) }}" method="POST">
        <!-- تحديث الحالة -->
    </form>
@endif
```

### 3. تحسينات إضافية

- إضافة عرض اسم المكلف
- تحسين عرض الحالة والأولوية باستخدام badges
- تنسيق تاريخ التسليم

## التغييرات المطبقة

### في TaskController.php

1. **دالة `show`**:
   - إضافة تمرير متغير `$isManagerOfTeam`
   - تحسين منطق التحقق من الصلاحيات

### في resources/views/manager/tasks/show.blade.php

- إصلاح المسارات لتستخدم مسارات المدير الصحيحة
- إضافة عرض معلومات إضافية
- تحسين التصميم باستخدام badges

## نتائج الإصلاح

✅ **تم حل مشكلة 403 بنجاح**

- المدير يمكنه الآن الوصول لصفحة تفاصيل المهام التي يديرها
- أزرار التعديل والحذف تظهر بشكل صحيح
- المسارات تعمل بشكل صحيح
- واجهة المستخدم محسنة

## التأكد من الإصلاح

للتأكد من أن الإصلاح يعمل:

1. سجل دخول كمدير
2. انتقل إلى "إدارة المهام"
3. اضغط على "عرض" لأي مهمة
4. تأكد من أن الصفحة تفتح بدون رسالة 403
5. تأكد من أن أزرار التعديل والحذف تظهر

## ملاحظات مهمة

- الإصلاح يحافظ على الأمان والصلاحيات
- تم مسح الكاش للتأكد من تطبيق التغييرات
- جميع المسارات تعمل بشكل صحيح
- واجهة المستخدم محسنة ومتسقة

## الحالة النهائية

✅ **تم حل جميع المشاكل**

- المدير يمكنه عرض مهام فريقه
- المدير يمكنه تعديل وحذف مهام فريقه
- المدير يمكنه إضافة مهام جديدة
- جميع المسارات تعمل بشكل صحيح
- واجهة المستخدم تعمل بشكل مثالي 