# نظام الإشعارات - Task Management System

## نظرة عامة

تم إضافة نظام إشعارات شامل إلى نظام إدارة المهام، حيث يتم إرسال إشعارات تلقائية عند حدوث أحداث معينة في النظام.

## أنواع الإشعارات

### 1. إشعارات إنشاء المهام (`task_created`)
- **متى يتم إرسالها:** عند إنشاء مهمة جديدة
- **المستقبلون:**
  - العضو المكلف بالمهمة
  - المدير والأدمن في نفس الفريق
- **المحتوى:** رسالة تفيد بإنشاء مهمة جديدة مع تفاصيلها

### 2. إشعارات تحديث المهام (`task_updated`)
- **متى يتم إرسالها:** عند تحديث بيانات المهمة
- **المستقبلون:**
  - العضو المكلف بالمهمة
  - المدير والأدمن في نفس الفريق
- **المحتوى:** رسالة تفيد بتحديث المهمة مع تفاصيل التغييرات

### 3. إشعارات تغيير حالة المهام (`task_status_changed`)
- **متى يتم إرسالها:** عند تغيير حالة المهمة
- **المستقبلون:**
  - المدير والأدمن في نفس الفريق
- **المحتوى:** رسالة تفيد بتغيير الحالة مع الحالة القديمة والجديدة

## كيفية عمل النظام

### 1. قاعدة البيانات
- جدول `notifications` يحتوي على:
  - `user_id`: معرف المستخدم المستقبل
  - `type`: نوع الإشعار
  - `message`: رسالة الإشعار
  - `data`: بيانات إضافية (JSON)
  - `is_read`: حالة القراءة
  - `read_at`: وقت القراءة

### 2. Service Class
- `NotificationService` يحتوي على methods ثابتة:
  - `taskStatusChanged()`: إرسال إشعار عند تغيير الحالة
  - `taskCreated()`: إرسال إشعار عند إنشاء مهمة
  - `taskUpdated()`: إرسال إشعار عند تحديث مهمة
  - `markAsRead()`: تحديد إشعار كمقروء
  - `markAllAsRead()`: تحديد جميع الإشعارات كمقروءة

### 3. Controller
- `NotificationController` يوفر:
  - عرض جميع الإشعارات
  - عرض الإشعارات غير المقروءة
  - تحديد إشعار كمقروء
  - حذف إشعار
  - APIs للـ AJAX

## الواجهات

### 1. صفحة جميع الإشعارات
- **المسار:** `/notifications`
- **الميزات:**
  - عرض جميع الإشعارات مع ترتيب زمني
  - تمييز الإشعارات غير المقروءة
  - إمكانية تحديد إشعار كمقروء
  - إمكانية حذف إشعار
  - أزرار لتحديد الكل كمقروء أو حذف الكل

### 2. صفحة الإشعارات غير المقروءة
- **المسار:** `/notifications/unread`
- **الميزات:**
  - عرض الإشعارات غير المقروءة فقط
  - إمكانية تحديد الكل كمقروء

### 3. أيقونة الإشعارات في Navigation
- **الموقع:** في شريط التنقل العلوي
- **الميزات:**
  - عرض عدد الإشعارات غير المقروءة
  - رابط مباشر لصفحة الإشعارات
  - تحديث تلقائي للعدد

## التكامل مع النظام

### 1. في TaskController
```php
// عند إنشاء مهمة
NotificationService::taskCreated($task, $request->user());

// عند تحديث مهمة
NotificationService::taskUpdated($task, $request->user(), $changes);

// عند تغيير حالة المهمة
NotificationService::taskStatusChanged($task, $user, $oldStatus, $newStatus);
```

### 2. في ManagerTeamController
```php
// عند إنشاء مهمة من قبل المدير
NotificationService::taskCreated($task, $user);

// عند تحديث مهمة من قبل المدير
NotificationService::taskUpdated($task, $user, $changes);
```

## الأمان والصلاحيات

### 1. التحقق من الملكية
- كل مستخدم يمكنه رؤية إشعاراته فقط
- لا يمكن تعديل أو حذف إشعارات الآخرين

### 2. التحقق من الصلاحيات
- الإشعارات ترسل فقط للمستخدمين المصرح لهم
- المديرون والأدمنون يتلقون إشعارات فرقهم فقط

## التخصيص والتوسيع

### 1. إضافة أنواع إشعارات جديدة
```php
// في NotificationService
public static function newNotificationType($data, $user)
{
    // منطق الإشعار الجديد
}
```

### 2. تخصيص الرسائل
- يمكن تخصيص رسائل الإشعارات حسب اللغة
- يمكن إضافة متغيرات ديناميكية في الرسائل

### 3. إضافة إشعارات في الوقت الفعلي
- يمكن إضافة WebSockets للإشعارات الفورية
- يمكن إضافة إشعارات البريد الإلكتروني

## الاستخدام

### 1. للمطورين
```php
// إرسال إشعار مخصص
Notification::create([
    'user_id' => $userId,
    'type' => 'custom_type',
    'message' => 'رسالة مخصصة',
    'data' => ['key' => 'value'],
]);
```

### 2. للمستخدمين
- الوصول للإشعارات من أيقونة في شريط التنقل
- تصفح الإشعارات وتحديدها كمقروءة
- حذف الإشعارات غير المرغوب فيها

## الصيانة

### 1. تنظيف الإشعارات القديمة
```php
// حذف الإشعارات الأقدم من 30 يوم
Notification::where('created_at', '<', now()->subDays(30))->delete();
```

### 2. إحصائيات الإشعارات
```php
// عدد الإشعارات غير المقروءة
$unreadCount = $user->unreadNotifications()->count();

// عدد الإشعارات حسب النوع
$typeCount = $user->notifications()->groupBy('type')->count();
``` 